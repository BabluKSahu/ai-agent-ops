name: Dispatch Orchestrator Run

on:
  workflow_dispatch:
    inputs:
      workflow_type:
        description: 'Workflow type'
        required: true
        default: 'market_research_then_build'
        type: choice
        options:
          - market_research_then_build
          - product_build_only
      seed_niches:
        description: 'Seed niches (comma separated)'
        required: false
        default: 'productivity templates,local marketing kits,micro-saas for creators'
  repository_dispatch:
    types: [trigger-orchestrator]

jobs:
  dispatch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Parse inputs
        id: parse
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "WORKFLOW_TYPE=${{ github.event.inputs.workflow_type }}" >> $GITHUB_ENV
            echo "SEED_NICHES=${{ github.event.inputs.seed_niches }}" >> $GITHUB_ENV
          else
            echo "WORKFLOW_TYPE=market_research_then_build" >> $GITHUB_ENV
            echo "SEED_NICHES=productivity templates,local marketing kits,micro-saas for creators" >> $GITHUB_ENV
          fi
      
      - name: Convert seed niches to array
        id: convert
        run: |
          IFS=',' read -ra NICHE_ARRAY <<< "${{ env.SEED_NICHES }}"
          JSON_ARRAY="["
          for i in "${NICHE_ARRAY[@]}"; do
            JSON_ARRAY="$JSON_ARRAY\"$(echo $i | xargs)\","
          done
          JSON_ARRAY="${JSON_ARRAY%,}]"
          echo "NICHES_JSON=$JSON_ARRAY" >> $GITHUB_ENV
      
      - name: Debug - Print Webhook URL (masked)
        env:
          ORCH_URL: ${{ secrets.ORCH_URL }}
        run: |
          echo "üîç Checking ORCH_URL secret..."
          if [ -z "$ORCH_URL" ]; then
            echo "‚ùå ORCH_URL secret is not set"
            exit 1
          else
            # Show first 20 chars and last 20 chars
            URL_LENGTH=${#ORCH_URL}
            FIRST_CHARS=${ORCH_URL:0:20}
            LAST_CHARS=${ORCH_URL: -20}
            echo "‚úÖ ORCH_URL found (length: $URL_LENGTH chars)"
            echo "üìå URL starts with: $FIRST_CHARS..."
            echo "üìå URL ends with: ...$LAST_CHARS"
          fi
      
      - name: Test n8n webhook connection
        env:
          ORCH_URL: ${{ secrets.ORCH_URL }}
        run: |
          echo "üß™ Testing webhook connection..."
          
          # Test 1: Basic connectivity
          echo "Test 1: Basic HTTP connectivity"
          curl -I -s "https://lumineerco1.app.n8n.cloud" -o /dev/null -w "Status: %{http_code}\n" || echo "‚ùå Cannot reach n8n.cloud"
          
          # Test 2: Webhook ping
          echo -e "\nTest 2: Webhook ping"
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "$ORCH_URL" \
            -H "Content-Type: application/json" \
            -d '{"ping": true}' || echo "CURL_FAILED")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          if [[ "$HTTP_CODE" == "200" ]]; then
            echo "‚úÖ Webhook reachable! HTTP $HTTP_CODE"
          elif [[ "$HTTP_CODE" == "404" ]]; then
            echo "‚ùå Webhook path not found (404) - Check if workflow is ACTIVE"
          elif [[ "$HTTP_CODE" == "403" ]]; then
            echo "‚ùå Forbidden (403) - Check n8n permissions"
          else
            echo "‚ùå Webhook not reachable. HTTP $HTTP_CODE"
          fi
      
      - name: Trigger n8n Orchestrator Webhook
        env:
          ORCH_URL: ${{ secrets.ORCH_URL }}
        run: |
          if [ -z "$ORCH_URL" ]; then
            echo "‚ùå ORCH_URL secret is not set"
            exit 1
          fi
          
          echo "üöÄ Triggering n8n orchestrator with workflow: ${{ env.WORKFLOW_TYPE }}"
          echo "üì¶ Seed niches: ${{ env.SEED_NICHES }}"
          echo "üåê Webhook URL: $ORCH_URL"
          
          # Proper JSON escaping
          TASK_ID="gh-run-$(date +%s)"
          WORKFLOW_TYPE="${{ env.WORKFLOW_TYPE }}"
          NICHES_JSON="${{ env.NICHES_JSON }}"
          
          # Create JSON payload properly
          PAYLOAD=$(cat <<EOF
          {
            "task_id": "$TASK_ID",
            "workflow": "$WORKFLOW_TYPE",
            "seed_niches": $NICHES_JSON
          }
          EOF
          )
          
          echo "üì§ Sending payload: $PAYLOAD"
          
          # Send request with verbose output for debugging
          curl -v -X POST "$ORCH_URL" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD" \
            -o /tmp/orch_response.json \
            -w "\nüì° HTTP Status: %{http_code}\n" \
            --max-time 30
          
          CURL_EXIT_CODE=$?
          
          if [ $CURL_EXIT_CODE -ne 0 ]; then
            echo "‚ùå cURL failed with exit code: $CURL_EXIT_CODE"
            echo "Common exit codes:"
            echo "  3  - Malformed URL"
            echo "  6  - Couldn't resolve host"
            echo "  7  - Failed to connect"
            echo "  28 - Timeout"
            exit $CURL_EXIT_CODE
          fi
          
          echo ""
          echo "‚úÖ Orchestrator Response:"
          cat /tmp/orch_response.json || echo "No response body"
          
      - name: Upload response artifact
        if: always()  # Run even if previous step fails
        uses: actions/upload-artifact@v4
        with:
          name: orchestrator-response-${{ github.run_id }}
          path: /tmp/orch_response.json
          retention-days: 7
          if-no-files-found: warn
